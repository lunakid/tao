Code cleanup: better separation of layers